if [ -f $sessionfile ]; then
    # Read $sessionfile and use entries to create relevant files
    {
    bestQCPass=0  # to keep track of the highest QCPass value
    bestFile=""   # to store the best file name with the highest QCPass value
    counter=0
    read
    while IFS= read -r line
    do
        # check if the file/image has passed QC (qc_pass_fail = 4th column)
        QCPass=`echo "$line" | awk '{ print $4 }'`

        # Checking for files with MCRIB in the name
        file=`echo "$line" | awk '{ print $3 }'`
        if echo "$file" | grep -q "MCRIB"; then
            # If the current QCPass value is greater than the bestQCPass value
            if (( $(echo "$QCPass > $bestQCPass" | bc -l) )); then
                bestQCPass=$QCPass
                bestFile=$file
            fi
        fi
    done < "$sessionfile"

    # Now process only the best file
    if [ ! -z "$bestFile" ]; then
        echo "Best file with QCPass=$bestQCPass is: $bestFile"
        filebase=`basename $bestFile .nii.gz`
        filedir=`dirname $bestFile`
        let counter++
        if [ ! -f $datadir/anat/$filebase.mif.gz ]; then
            cp $origdatadir/$filedir/$filebase.nii.gz $origdatadir/$filedir/$filebase.json $datadir/.
        fi
    fi
    }
fi
